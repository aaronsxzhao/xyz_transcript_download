name: Continuous Testing

on:
  # Run every 30 minutes
  schedule:
    - cron: '*/30 * * * *'
  
  # Run on push to main
  push:
    branches: [main]
  
  # Run on pull requests
  pull_request:
    branches: [main]
  
  # Allow manual trigger
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  DEFAULT_DEPLOY_URL: 'https://xyz-transcript-download.onrender.com'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Set test environment variables
        run: |
          echo "USE_SUPABASE=false" >> $GITHUB_ENV
          echo "WHISPER_MODE=local" >> $GITHUB_ENV
          echo "LLM_API_KEY=test-key" >> $GITHUB_ENV
          echo "LLM_BASE_URL=https://test.api.com" >> $GITHUB_ENV
          echo "LLM_MODEL=test-model" >> $GITHUB_ENV
      
      - name: Run tests with coverage
        id: pytest
        run: |
          python -m pytest tests/ \
            --cov=api \
            --cov=database \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=test-results.xml \
            -v \
            --tb=short \
            2>&1 | tee test-output.txt
        continue-on-error: true
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
            test-output.txt
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true
      
      - name: Check test results
        if: steps.pytest.outcome == 'failure'
        run: |
          echo "::error::Tests failed! Check the test output for details."
          exit 1
      
      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read test output
            let testOutput = '';
            try {
              testOutput = fs.readFileSync('test-output.txt', 'utf8');
              // Truncate if too long
              if (testOutput.length > 5000) {
                testOutput = testOutput.slice(-5000);
              }
            } catch (e) {
              testOutput = 'Could not read test output';
            }
            
            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated-test,bug',
              per_page: 5
            });
            
            // Check if there's already an issue for test failures
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('[Auto] Test Failure')
            );
            
            const timestamp = new Date().toISOString();
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = `## Automated Test Failure Report
            
            **Time**: ${timestamp}
            **Workflow Run**: [View Run](${runUrl})
            **Trigger**: Scheduled (every 30 minutes)
            
            ### Test Output (last 5000 chars)
            
            \`\`\`
            ${testOutput}
            \`\`\`
            
            ### Next Steps
            
            1. Review the test output above
            2. Check the [workflow run](${runUrl}) for full details
            3. Fix the failing tests
            4. Close this issue when resolved
            
            ---
            *This issue was automatically created by the continuous testing workflow.*
            `;
            
            if (existingIssue) {
              // Update existing issue with new failure info
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### New Failure at ${timestamp}\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Auto] Test Failure - ${timestamp.split('T')[0]}`,
                body: body,
                labels: ['automated-test', 'bug']
              });
              console.log('Created new issue for test failure');
            }

  # Separate job to run on schedule only - checks API health
  health-check:
    name: API Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Check deployed API health
        id: health
        run: |
          # Replace with your actual deployed URL
          DEPLOY_URL="${DEPLOY_URL_OVERRIDE:-${{ env.DEFAULT_DEPLOY_URL }}}"
          
          echo "Checking health at: $DEPLOY_URL/api/health"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/api/health" || echo "000")
          
          echo "Response code: $RESPONSE"
          
          if [ "$RESPONSE" != "200" ]; then
            echo "::warning::API health check failed with status $RESPONSE"
            echo "health_status=unhealthy" >> $GITHUB_OUTPUT
          else
            echo "API is healthy"
            echo "health_status=healthy" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Report unhealthy status
        if: steps.health.outputs.health_status == 'unhealthy'
        run: |
          echo "::warning::The deployed API may be unhealthy. Check Render dashboard."

  # Summary job
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    
    steps:
      - name: Check test status
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ All tests passed!"
            exit 0
          else
            echo "❌ Some tests failed. Check the test job for details."
            exit 1
          fi
